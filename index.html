<!DOCTYPE html><html lang="de">  <head>  
  <meta charset="utf-8">  
  <title>Flugspur App mit Cesium (2D/3D)</title>  
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>  
  <style>  
    html, body {  
      margin: 0;  
      padding: 0;  
      height: 100%;  
      width: 100%;  
      font-family: sans-serif;  
      background: #f0f0f0;  
      overflow: hidden;  
    }  
    #cesiumContainer {  
      position: absolute;  
      top: 0;  
      left: 0;  
      width: 100%;  
      height: 75%;  
    }  
    #chartContainer {  
      position: absolute;  
      bottom: 0;  
      left: 0;  
      width: 100%;  
      height: 25%;  
      background: #fff;  
      padding: 10px;  
      box-sizing: border-box;  
    }  
    #mainChart {  
      width: 100%;  
      height: 100%;  
    }  
    #switchView, #openFile {  
      position: fixed;  
      top: 10px;  
      z-index: 2000;  
      background: #333;  
      color: white;  
      padding: 10px 20px;  
      border: none;  
      border-radius: 10px;  
      cursor: pointer;  
      font-size: 14px;  
      box-shadow: 0 2px 5px rgba(0,0,0,0.4);  
    }  
    #switchView { left: 10px; }  
    #openFile { left: 140px; }  
    #fileInput { display: none; }  
  </style>  
</head>  
<body><button id="switchView">Wechsel zu 2D</button> <button id="openFile">Datei auswählen</button> <input type="file" id="fileInput" accept=".kml">  <div id="cesiumContainer"></div>  
<div id="chartContainer">  
  <canvas id="mainChart"></canvas>  </div><script>  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5ZTI3MDRmMy1mYjg5LTRjNmYtYjBmZC1kZDQxN2NlNzVkZDEiLCJpZCI6Mjk3NzA1LCJpYXQiOjE3NDU5MzE5MTh9.svRycz7t606srY9WbWiWUaLB2hJpycWmo835Dy-VWtw';

const viewer = new Cesium.Viewer('cesiumContainer', {
sceneMode: Cesium.SceneMode.SCENE3D,
baseLayerPicker: true,
animation: false,
timeline: false,
terrainProvider: undefined
});

let fullCoords = [];
let mainChart;
let cesiumEntity = null;

// Umschalten zwischen 3D und 2D
let is3D = true;
document.getElementById('switchView').onclick = () => {
is3D = !is3D;
viewer.scene.mode = is3D ? Cesium.SceneMode.SCENE3D : Cesium.SceneMode.SCENE2D;
document.getElementById('switchView').textContent = is3D ? 'Wechsel zu 2D' : 'Wechsel zu 3D';
};

// Datei auswählen sichtbar machen
document.getElementById('openFile').onclick = () => {
document.getElementById('fileInput').click();
};

document.getElementById('fileInput').addEventListener('change', function(event) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = function(e) {
const text = e.target.result;
const lines = text.split(/\r?\n/);
fullCoords = [];
let currentTime = null;
for (let line of lines) {
line = line.trim();
if (line.startsWith('<name>')) {
const timeText = line.replace('<name>', '').replace('</name>', '').trim();
const [hours, minutes, seconds] = timeText.split(':').map(Number);
currentTime = hours * 3600 + minutes * 60 + seconds;
}
if (line.includes('<coordinates>')) {
const coordsText = line.substring(line.indexOf('>') + 1, line.indexOf('</coordinates>')).trim();
const [lon, lat, alt] = coordsText.split(',').map(Number);
if (currentTime !== null) {
fullCoords.push({ seconds: currentTime, lon: lon, lat: lat, alt: alt });
currentTime = null;
}
}
}
if (fullCoords.length > 0) {
updateCesiumFlightPath(fullCoords);
createChart();
}
};
reader.readAsText(file);
});

function updateCesiumFlightPath(coords) {
if (cesiumEntity) viewer.entities.remove(cesiumEntity);
const flat = [];
coords.forEach(p => flat.push(p.lon, p.lat, p.alt));
cesiumEntity = viewer.entities.add({
polyline: {
positions: Cesium.Cartesian3.fromDegreesArrayHeights(flat),
width: 3,
material: Cesium.Color.RED.withAlpha(0.9)
}
});
viewer.camera.flyTo({
destination: Cesium.Cartesian3.fromDegrees(coords[0].lon, coords[0].lat, 2000.0)
});
}

function createChart() {
const ctx = document.getElementById('mainChart').getContext('2d');
const seconds = fullCoords.map(p => p.seconds);
const altitude = fullCoords.map(p => p.alt);
const speeds = [0];
for (let i = 1; i < fullCoords.length; i++) {
const dx = fullCoords[i].lon - fullCoords[i - 1].lon;
const dy = fullCoords[i].lat - fullCoords[i - 1].lat;
const distance = Math.sqrt(dx * dx + dy * dy) * 111320;
const dt = fullCoords[i].seconds - fullCoords[i - 1].seconds;
speeds.push(dt > 0 ? (distance / dt) * 3.6 : 0);
}
if (mainChart) mainChart.destroy();
mainChart = new Chart(ctx, {
type: 'line',
data: {
labels: seconds,
datasets: [
{ label: 'Höhe (m)', data: altitude, borderColor: 'blue', yAxisID: 'y1', pointRadius: 0, tension: 0.2 },
{ label: 'Geschwindigkeit (km/h)', data: speeds, borderColor: 'green', yAxisID: 'y2', pointRadius: 0, tension: 0.2 }
]
},
options: {
responsive: true,
animation: false,
plugins: {
legend: { display: true },
annotation: {
annotations: {
line: {
type: 'line',
borderColor: 'red',
borderWidth: 2,
scaleID: 'x',
value: seconds[0],
draggable: true,
onDragEnd: function(e) {
const second = e.chart.options.plugins.annotation.annotations.line.value;
}
}
}
}
},
scales: {
x: { title: { display: true, text: 'Zeit (s)' }, ticks: { stepSize: 10 } },
y1: { type: 'linear', position: 'left', title: { display: true, text: 'Höhe (m)' } },
y2: { type: 'linear', position: 'right', title: { display: true, text: 'km/h' }, grid: { drawOnChartArea: false } }
}
}
});
}
</script></body>

</html>